# Savory AI Server - Product Specification Document

## 1. Обзор продукта

### 1.1 Название
**Savory AI** — REST API сервер для системы управления ресторанами с AI-чатом.

### 1.2 Описание
Savory AI — это комплексная backend-система для ресторанного бизнеса, обеспечивающая управление меню, столами, заказами и коммуникацией с гостями через AI-чат. Система поддерживает мультиарендность (multi-tenancy) на уровне организаций.

### 1.3 Целевая аудитория
- Владельцы ресторанов и ресторанных сетей
- Управляющие ресторанами
- Гости ресторанов (через QR-коды и чат)

---

## 2. Технический стек

| Компонент | Технология |
|-----------|------------|
| Язык | Go 1.23.4 |
| Web-фреймворк | Fiber v2 |
| ORM | GORM |
| База данных | PostgreSQL |
| DI-контейнер | Uber FX |
| Аутентификация | JWT (HS256) |
| Логирование | Zerolog |
| Валидация | go-playground/validator |
| QR-коды | skip2/go-qrcode |
| Контейнеризация | Docker, Docker Compose |

---

## 3. Архитектура

### 3.1 Паттерн
Clean Architecture с разделением на слои:

```
Controller (HTTP) → Service (бизнес-логика) → Repository (БД)
```

### 3.2 Структура модулей
Каждый бизнес-модуль содержит:
- `controller/` — HTTP-обработчики
- `service/` — бизнес-логика
- `repository/` — работа с БД
- `payload/` — DTO (request/response)

---

## 4. Функциональные модули

### 4.1 Аутентификация (auth)

**Назначение:** Управление доступом пользователей к системе.

**Функциональность:**
- Регистрация новых пользователей
- Авторизация (login)
- Смена пароля
- Сброс пароля через код подтверждения
- Проверка статуса аутентификации

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| POST | /auth/login | Вход в систему |
| POST | /auth/register | Регистрация |
| POST | /auth/change-password | Смена пароля |
| POST | /auth/request-password-reset | Запрос сброса пароля |
| POST | /auth/verify-password-reset | Подтверждение сброса |
| GET | /auth/chek | Проверка авторизации |

---

### 4.2 Пользователи (user)

**Назначение:** Управление профилями пользователей.

**Функциональность:**
- Получение информации о пользователе
- Обновление профиля
- Создание новых пользователей

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /user/:id | Получить пользователя |
| PATCH | /user/:id | Обновить профиль |
| POST | /user/ | Создать пользователя |

---

### 4.3 Организации (organization)

**Назначение:** Управление организациями (мультиарендность).

**Функциональность:**
- CRUD операции с организациями
- Управление пользователями организации
- Привязка языков к организации

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /organization/ | Список организаций |
| GET | /organization/:id | Детали организации |
| PATCH | /organization/:id | Обновить организацию |
| POST | /organization/:id/users | Добавить пользователя |
| DELETE | /organization/:id/users | Удалить пользователя |
| GET | /organization/:id/languages | Языки организации |
| POST | /organization/:id/languages | Добавить язык |
| DELETE | /organization/:id/languages | Удалить язык |

---

### 4.4 Языки (language)

**Назначение:** Поддержка мультиязычности.

**Функциональность:**
- Управление списком доступных языков
- Привязка языков к организациям
- Поддержка вопросов на разных языках

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /languages/ | Список языков |
| GET | /languages/:id | Детали языка |
| POST | /languages/ | Создать язык |
| PATCH | /languages/:id | Обновить язык |
| DELETE | /languages/:id | Удалить язык |

---

### 4.5 Рестораны (restaurant)

**Назначение:** Управление ресторанами.

**Функциональность:**
- CRUD операции с ресторанами
- Управление рабочими часами
- Привязка к организации

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /restaurants/ | Список ресторанов |
| GET | /restaurants/:id | Детали ресторана |
| GET | /restaurants/organization/:id | Рестораны организации |
| POST | /restaurants/ | Создать ресторан |
| PUT | /restaurants/:id | Обновить ресторан |
| DELETE | /restaurants/:id | Удалить ресторан |

---

### 4.6 Столы (table)

**Назначение:** Управление столами в ресторане.

**Функциональность:**
- CRUD операции со столами
- Указание вместимости (количество гостей)
- Привязка меню к столу

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /tables/ | Список столов |
| GET | /tables/:id | Детали стола |
| GET | /tables/restaurant/:id | Столы ресторана |
| POST | /tables/ | Создать стол |
| PUT | /tables/:id | Обновить стол |
| DELETE | /tables/:id | Удалить стол |

---

### 4.7 Категории меню (menu_category)

**Назначение:** Организация меню по категориям.

**Функциональность:**
- CRUD операции с категориями
- Привязка блюд к категориям

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /categories/ | Список категорий |
| GET | /categories/:id | Детали категории |
| POST | /categories/ | Создать категорию |
| DELETE | /categories/:id | Удалить категорию |

---

### 4.8 Блюда (dish)

**Назначение:** Управление блюдами меню.

**Функциональность:**
- CRUD операции с блюдами
- Управление ингредиентами и аллергенами
- Функция "Блюдо дня"

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /dishes/ | Список блюд |
| GET | /dishes/:id | Детали блюда |
| GET | /dishes/category | Блюда по категории |
| GET | /dishes/dish-of-day | Блюдо дня |
| POST | /dishes/dish-of-day/:id | Назначить блюдо дня |
| POST | /dishes/ | Создать блюдо |
| PUT | /dishes/:id | Обновить блюдо |
| DELETE | /dishes/:id | Удалить блюдо |

---

### 4.9 Вопросы (question)

**Назначение:** Мультиязычные вопросы для опросов/обратной связи.

**Функциональность:**
- Создание вопросов с привязкой к языку
- Фильтрация по языку

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /questions/ | Список вопросов |
| GET | /questions/language/:code | Вопросы на языке |
| POST | /questions/ | Создать вопрос |
| PUT | /questions/:id | Обновить вопрос |
| DELETE | /questions/:id | Удалить вопрос |

---

### 4.10 QR-коды (qr_code)

**Назначение:** Генерация QR-кодов для ресторанов и столов.

**Функциональность:**
- Генерация QR-кода ресторана
- Генерация QR-кода стола
- Скачивание в формате PNG

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /qrcodes/restaurant/:id | QR ресторана |
| GET | /qrcodes/restaurant/:id/download | Скачать QR ресторана |
| GET | /qrcodes/restaurant/:id/table/:table_id | QR стола |
| GET | /qrcodes/restaurant/:id/table/:table_id/download | Скачать QR стола |

---

### 4.11 Загрузка файлов (file_upload)

**Назначение:** Управление загрузкой изображений.

**Функциональность:**
- Загрузка изображений
- Уникальные имена файлов (timestamp-based)
- Хранение в локальной файловой системе

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| POST | /uploads/images | Загрузить изображение |

---

### 4.12 Чат (chat)

**Назначение:** AI-чат система для коммуникации.

**Функциональность:**
- Чат-сессии для столов (гости)
- Чат-сессии для ресторанов
- Типы авторов: user, bot, restaurant
- История сообщений

**Endpoints для столов:**
| Метод | Путь | Описание |
|-------|------|----------|
| POST | /chat/table/session/start | Начать сессию |
| POST | /chat/table/session/close/:id | Закрыть сессию |
| POST | /chat/table/message/send | Отправить сообщение |
| GET | /chat/table/session/:id/messages | История сообщений |
| GET | /chat/table/session/:table_id | Сессии стола |

**Endpoints для ресторанов:**
| Метод | Путь | Описание |
|-------|------|----------|
| POST | /chat/restaurant/session/start | Начать сессию |
| POST | /chat/restaurant/session/close/:id | Закрыть сессию |
| POST | /chat/restaurant/message/send | Отправить сообщение |
| GET | /chat/restaurant/session/:id/messages | История сообщений |
| GET | /chat/restaurant/sessions/:restaurant_id | Сессии ресторана |

---

### 4.13 Подписки (subscription)

**Назначение:** Управление подписками организаций.

**Функциональность:**
- CRUD операции с подписками
- Активация/деактивация
- Продление подписки
- Периоды подписки (месяцы)

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /subscriptions/ | Список подписок |
| GET | /subscriptions/:id | Детали подписки |
| GET | /subscriptions/organization/:id | Подписка организации |
| GET | /subscriptions/organization/:id/active | Активная подписка |
| POST | /subscriptions/ | Создать подписку |
| PUT | /subscriptions/:id | Обновить подписку |
| POST | /subscriptions/:id/extend | Продлить подписку |
| POST | /subscriptions/:id/deactivate | Деактивировать |
| DELETE | /subscriptions/:id | Удалить подписку |

---

### 4.14 Администрирование (admin)

**Назначение:** Панель администратора системы.

**Функциональность:**
- Управление пользователями (статус, роли)
- Управление организациями
- Модерация контента (блюда)
- Логирование действий администраторов
- Статистика системы

**Endpoints:**
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /admin/stats | Статистика системы |
| GET | /admin/users | Список пользователей |
| GET | /admin/users/:id | Детали пользователя |
| PATCH | /admin/users/:id/status | Изменить статус |
| PATCH | /admin/users/:id/role | Изменить роль |
| DELETE | /admin/users/:id | Удалить пользователя |
| GET | /admin/organizations | Список организаций |
| GET | /admin/organizations/:id | Детали организации |
| DELETE | /admin/organizations/:id | Удалить организацию |
| GET | /admin/dishes | Список блюд |
| DELETE | /admin/dishes/:id | Удалить блюдо |
| GET | /admin/logs | Логи действий |
| GET | /admin/logs/me | Мои логи |

---

## 5. Модель данных

### 5.1 Основные сущности

```
┌─────────────┐     ┌──────────────┐     ┌────────────┐
│    User     │────<│ Organization │>────│ Restaurant │
└─────────────┘     └──────────────┘     └────────────┘
                           │                    │
                           │                    ├────< WorkingHour
                           │                    │
                    ┌──────┴──────┐             └────< Table
                    │             │                      │
              ┌─────┴─────┐  ┌────┴────┐          ChatSession
              │  Language │  │MenuCategory│              │
              └───────────┘  └─────┬─────┘        ChatMessage
                                   │
                             ┌─────┴─────┐
                             │   Dish    │
                             └─────┬─────┘
                                   │
                       ┌───────────┼───────────┐
                       │                       │
                 ┌─────┴─────┐           ┌─────┴─────┐
                 │ Ingredient│           │  Allergen │
                 └───────────┘           └───────────┘
```

### 5.2 Описание сущностей

| Сущность | Описание | Ключевые поля |
|----------|----------|---------------|
| User | Пользователь системы | id, name, email, role (user/admin) |
| Organization | Организация (арендатор) | id, name, admin_id |
| Restaurant | Ресторан | id, organization_id, name, address |
| Table | Стол в ресторане | id, restaurant_id, name, guest_count |
| MenuCategory | Категория меню | id, organization_id, name |
| Dish | Блюдо | id, category_id, name, price, is_dish_of_day |
| Ingredient | Ингредиент блюда | id, dish_id, name, quantity |
| Allergen | Аллерген блюда | id, dish_id, name |
| Language | Язык | id, code, name |
| Question | Вопрос | id, organization_id, language_id, text |
| Subscription | Подписка | id, organization_id, period, is_active |
| AdminLog | Лог действий | id, admin_id, action, entity_type |

---

## 6. Безопасность

### 6.1 Аутентификация
- JWT токены с алгоритмом HS256
- Время жизни токена: настраивается (по умолчанию ~100 часов)
- Хэширование паролей: bcrypt

### 6.2 Авторизация
- Role-Based Access Control (RBAC)
- Роли: `user`, `admin`
- Middleware: `AuthRequired`, `AdminRequired`

### 6.3 Валидация
- Валидация входных данных через go-playground/validator
- Структурированные сообщения об ошибках

---

## 7. Развертывание

### 7.1 Переменные окружения
- `CONFIG_FILE` — путь к файлу конфигурации

### 7.2 Docker
```bash
docker-compose up -d
```

### 7.3 Команды запуска
```bash
# С миграциями
go run cmd/main.go -migrate

# С сидированием
go run cmd/main.go -seed
```

### 7.4 Порты
- API сервер: 4000
- PostgreSQL: 5432

---

## 8. Конфигурация

Основные параметры (`config/config.toml`):

| Секция | Параметр | Описание |
|--------|----------|----------|
| app | port | Порт сервера (:4000) |
| app | host | Хост (0.0.0.0) |
| db.postgres | dsn | Строка подключения к PostgreSQL |
| middleware.jwt | secret | Секретный ключ JWT |
| middleware.jwt | expiration_seconds | Время жизни токена |
| middleware.filesystem | root | Путь к статическим файлам |


---

## 10. Версионирование

**Текущая версия:** 1.0.0 (development)

**Последние изменения:**
- Добавлен модуль подписок (Subscription API)
- Исправления в модулях ресторанов и столов
- Добавлена поддержка языков
- Добавлен модуль администрирования

---

*Документ сгенерирован: Ноябрь 2024*
